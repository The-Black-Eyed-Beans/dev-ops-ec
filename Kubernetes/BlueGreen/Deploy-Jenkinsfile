pipeline {
    agent any

    environment {
        AWS_REGION = credentials("AWS_REGION")
        AWS_ID = credentials("AWS_ID")
        COMMIT_HASH = "latest"
        BANK_REPLICAS = 1
        GATEWAY_REPLICAS = 1
        HOST = "aline.localdev.me"
    }

    stages {
        stage("Get current state of deployment") {
            steps {
                script {
                    def output = sh(returnStdout: true, script: "kubectl get service -n afs-ec")
                    if(output.contains("green") && output.contains("blue")){
                        env.DEPLOYMENT_STATE = "both"
                        def ingress_output = sh(returnStdout: true, script: "kubectl get ingress main-ingress -o yaml -n afs-ec")
                        if(ingress_output.contains("blue")){
                            env.NEW_COLOR = "green"
                            env.OLD_COLOR = "blue"
                        }else if(ingress_output.contains("green")){
                            env.NEW_COLOR = "blue"
                            env.OLD_COLOR = "green"
                        }else{
                            echo "Error: Services were running but no ingress was created"
                            return
                        }
                    }else if(output.contains("green")){
                        env.DEPLOYMENT_STATE = "one"
                        env.NEW_COLOR = "blue"
                        env.OLD_COLOR = "green"
                    }else if(output.contains("blue")){
                        env.DEPLOYMENT_STATE = "one"
                        env.NEW_COLOR = "green"
                        env.OLD_COLOR = "blue"
                    }else{
                        env.DEPLOYMENT_STATE = "neither"
                        env.OLD_COLOR = "blue"
                    }
                }
                // dir('Kubernetes/BlueGreen'){
                //     sh "envsubst < aline-bank.yaml | kubectl apply -f -"
                // }
                // env.DEPLOYMENT_COLOR = "green" inside script
            }
        }

        stage("Both deployed") {
                when {
                    environment(name: "DEPLOYMENT_STATE", value: "both")
                }
                steps {
                    echo "Both"
                }
        }

        stage("One deployed") {
                when {
                    environment(name: "DEPLOYMENT_STATE", value: "one")
                }
                steps {
                    echo "One"
                }
        }

        stage("None deployed") {
                when {
                    environment(name: "DEPLOYMENT_STATE", value: "neither")
                }
                steps {
                    sh "envsubst < aline-bank.yaml | kubectl apply -f -"
                    sh "envsubst < backend-service.yaml | kubectl apply -f -"
                    sh "envsubst < aline-gateway.yaml | kubectl apply -f -"
                    sh "envsubst < main-ingress.yaml | kubectl apply -f -"
                }
        }
    }
}