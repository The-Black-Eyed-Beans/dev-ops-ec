pipeline {
    agent any

    parameters{
        string(name: 'MICROSERVICE', defaultValue: 'bank', description: 'Which listener to change weights for')
        string(name: 'MAIN_WEIGHT', defaultValue: '80', description: 'Percentage of requests that get forwarded to main deployment')
    }

    stages{
        stage("Set up environment"){
            steps{
                script{
                    if(env.MAIN_WEIGHT.toInteger() > 100 || env.MAIN_WEIGHT.toInteger() < 0){
                        error 'Main weight must be between 0 to 100'
                    }
                    
                    if(env.MICROSERVICE == "bank"){
                        env.APP_PORT = "8083"
                    }else if(env.MICROSERVICE == "trans"){
                        env.APP_PORT = "8073"
                    }else if(env.MICROSERVICE == "under"){
                        env.APP_PORT = "8071"
                    }else if(env.MICROSERVICE == "user"){
                        env.APP_PORT = "8070"
                    }else{
                        error "Invalid microservice parameter"
                    }
                }
            }
        }

        stage("Get initial state"){
            steps{
                script{
                    def current_stacks = sh(returnStdout: true, script: "aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE")
                    if(current_stacks.contains("afs-ec-" + env.MICROSERVICE + "-blue") && current_stacks.contains("afs-ec-" + env.MICROSERVICE + "-green")){
                        def listener_output = sh(returnStdout: true, script: "aws cloudformation describe-stacks --stack-name afs-ec-${MICROSERVICE}-blue | jq -r .'Stacks[0]' | jq -r .'Parameters[0]'")
                        if(listener_output.contains(env.APP_PORT)){
                            env.MAIN_COLOR = "blue"
                            env.CANARY_COLOR = "green"
                        }else{
                            env.MAIN_COLOR = "green"
                            env.CANARY_COLOR = "blue"
                        }
                    }else{
                        error "Not enough deployments to swap"
                    }
                }
            }
        }

        stage("Save resource values") {
            steps{
                script{
                    env.MAIN_LISTENER = sh(returnStdout: true, script: "aws cloudformation describe-stacks --stack-name afs-ec-${MICROSERVICE}-${MAIN_COLOR} | jq -r .'Stacks[0]' | jq -r .'Outputs[0]' | jq -r .'OutputValue'")
                    env.MAIN_TARGET_GROUP = sh(returnStdout: true, script: "aws cloudformation describe-stacks --stack-name afs-ec-${MICROSERVICE}-${MAIN_COLOR} | jq -r .'Stacks[0]' | jq -r .'Outputs[1]' | jq -r .'OutputValue'")
                    env.CANARY_TARGET_GROUP = sh(returnStdout: true, script: "aws cloudformation describe-stacks --stack-name afs-ec-${MICROSERVICE}-${CANARY_COLOR} | jq -r .'Stacks[0]' | jq -r .'Outputs[1]' | jq -r .'OutputValue'")
                    env.CANARY_WEIGHT = 100 - env.MAIN_WEIGHT.toInteger()
                }
            }
        }

        stage("Update weighted listener"){
            steps {
                dir('ECS/Canary'){
                    sh '''
                        aws cloudformation deploy \
                            --stack-name afs-ec-${MICROSERVICE}-listener \
                            --template-file listener-stack.yaml \
                            --parameter-overrides \
                                MainListener=${MAIN_LISTENER} \
                                MainTargetGroup=${MAIN_TARGET_GROUP} \
                                CanaryTargetGroup=${CANARY_TARGET_GROUP} \
                                MainWeight=${MAIN_WEIGHT} \
                                CanaryWeight=${CANARY_WEIGHT} \
                            --no-fail-on-empty-changeset
                    '''
                }
            }
        }
    }
}